<%- include('../partials/user/header') %>


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />




<style>

    body {
      background-color: #f5f5f5;
    }

    .backInfo{
        background-color: #fff;
    }

  .text-grey {
    color: #46698f;
  }
  .btn-outline-grey {
    border-color: #46698f;
    color: #46698f;
  }
  .btn-outline-grey:hover {
    background-color: #46698f;
    color: #fff;
  }
</style>

<div class="container my-4">
  
  <div class="text-center mb-4 backInfo py-3">
    <h5>Order ID : <%= order.orderId %></h5>
    <% const activeItemsCount = order.orderedItems.filter(item => item.status !== 'Cancelled').length; %>
    <p>Placed on <%= order.createdOn.toDateString() %> • ₹<%= order.finalAmount %> for <%= activeItemsCount %> items</p>

    <% 
      const statusBadgeMap = {
        'Pending': 'secondary',
        'Processing': 'info',
        'Shipped': 'primary',
        'Out for delivery': 'warning',
        'Delivered': 'success',
        'Cancelled': 'danger',
        'Returned': 'dark'
      };

      const badgeColor = statusBadgeMap[order.status] || 'secondary';
    %>
      <h4 class="mb-3"> 
        <span class="badge bg-<%= badgeColor %> ms-2"><%= order.status %></span>
      </h4>


    <% if (order.status === 'Return Request' || order.status === 'Returned') { %>
      <div class="alert alert-warning mt-2">
        <strong>Return Reason:</strong> <%= order.returnReason %>
      </div>
    <% } %>

    


    <a href="/invoice/<%= order._id %>" class="btn btn-outline-grey btn-sm " target="_blank">
      <i class="bi bi-download"></i> Download Invoice
    </a>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="d-flex align-items-center justify-content-between mb-2 backInfo p-3">
        <div>
          <strong>TOTAL</strong>
          <p class="mb-0">₹<%= order.totalPrice %> for <%= activeItemsCount %> items</p>
        </div>
        <!-- <form action="/cancel-order" method="POST">
          <input type="hidden" name="orderId" value="<%= order.orderId %>">
          <button type="submit" class="btn btn-outline-pink btn-sm">CANCEL</button>
        </form> -->
        <% const allItemsCancelled = order.orderedItems.every(item => item.status === 'Cancelled')%>

        <% if (order.status === 'Cancelled'|| allItemsCancelled) { %>
          <button type="button" class="btn btn-outline-secondary btn-sm" disabled>Order Cancelled</button>
        <% } else { %>
          <button type="button" class="btn btn-outline-grey btn-sm" data-bs-toggle="modal" data-bs-target="#cancelOrderModal">Cancel Order</button>
        <% } %>

      </div>

      <% order.orderedItems.forEach(item => { %>
        <div class="card mb-3 border-0 shadow-sm">
          <div class="row g-0 align-items-center">
            <div class="col-md-2 text-center">
              <img src="/uploads/re-image/<%= item.product.productImage[0] %>" class="img-fluid" alt="Product Image">
            </div>
            <div class="col-md-6">
              <div class="card-body py-3">
                <h6><%= item.product.productName %></h6>
                <p class="mb-1 text-muted">Size: <%= item.size %> yrs</p>
                <p class="mb-1 text-muted">Qty: <%= item.quantity %></p>
              </div>
            </div>
            <div class="col-md-4 text-end pe-4">
              <% const totalItemPrice = item.price * item.quantity; %>
              <p class="mb-0">Total Price : ₹<%= totalItemPrice %></p>
              <!-- Cancel Item Button -->
             <!-- <button type="button" class="btn btn-outline-danger btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#cancelItemModal<%= item.product._id %>">
                Cancel Item
             </button> -->


             <% if (order.status !== 'Cancelled') { %>
              <% if (item.status === 'Confirmed') { %>
                <!-- Cancel Item Button -->
                <button type="button" class="btn btn-outline-danger btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#cancelItemModal<%= item.product._id %>">
                  Cancel Item
                </button>

                <!-- Cancel Item Modal -->
                <div class="modal fade" id="cancelItemModal<%= item.product._id %>" tabindex="-1" aria-labelledby="cancelItemModalLabel<%= item.product._id %>" aria-hidden="true">
                  <div class="modal-dialog">
                    <form action="/cancel-item" method="POST" class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="cancelItemModalLabel<%= item.product._id %>">Cancel Product</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <input type="hidden" name="orderId" value="<%= order.orderId %>">
                        <input type="hidden" name="productId" value="<%= item.product._id %>">
                        <label for="itemCancelReason<%= item.product._id %>" class="form-label">Reason (optional)</label>
                        <textarea class="form-control" name="reason" id="itemCancelReason<%= item.product._id %>" rows="3" placeholder="Why cancel this item?"></textarea>
                      </div>
                      <div class="modal-footer">
                        <button type="submit" class="btn btn-outline-danger">Confirm Cancel</button>
                      </div>
                    </form>
                  </div>
                </div>
              <% } else if (item.status === 'Cancelled') { %>
                <button type="button" class="btn btn-outline-secondary btn-sm mt-2" disabled>Item Cancelled</button>
              <% } %>
            <% } %>



            </div>
          </div>
        </div>



      <% }) %>
    </div>

    <div class="col-md-4">
     
        <% if (order.address) { %>
        <div class="mb-3 p-3 border rounded backInfo">
          <h6 class="fw-bold">SHIPPING ADDRESS</h6>
          <p class="mb-1"><b><%= order.address.name %></b></p>
          <p class="mb-1">Phone No: <%= order.address.phone %> / <%= order.address.altPhone %></p>
          <p class="mb-0">
            <%= order.address.houseName %>,<br> <%= order.address.streetName %>,<br> <%= order.address.landMark %>,<br>
            <%= order.address.city %> - <%= order.address.pincode %>, <%= order.address.state %>
          </p>
        </div>
      <% } else { %>
        <div class="mb-3 p-3 border rounded">
          <h6 class="fw-bold text-danger">SHIPPING ADDRESS</h6>
          <p class="text-danger mb-0">No address found for this order.</p>
        </div>
      <% } %>




      <div class="mb-3 p-3 border rounded backInfo">
        <h6 class="fw-bold">PAYMENT SUMMARY</h6>
        <div class="d-flex justify-content-between">
          <span>Total item price</span>
          <span>₹<%= order.totalPrice %></span>
        </div>
        <div class="d-flex justify-content-between">
          <span>Item discount</span>
          <span class="text-success">-₹<%= order.discount %></span>
        </div>
        <div class="d-flex justify-content-between">
          <% if (order.status !== 'Cancelled') { %>
            <span>Shipping</span>
            <span>₹<%= shipping %></span>
          <% } %>
        </div>
        <hr>
        <div class="d-flex justify-content-between fw-bold">
          <span>Total</span>
          <span>₹<%= order.finalAmount %></span>
        </div>
      </div>

      <div class="p-3 border rounded backInfo">
        <h6 class="fw-bold">PAYMENT MODE</h6>
        <p class="mb-1">Cash On Delivery</p>
        <p class="mb-2">₹<%= order.finalAmount %> due</p>
      </div>

      <!-- Cancel Order Modal -->
      <div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <form action="/cancel-order" method="POST" class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="cancelOrderModalLabel">Cancel Entire Order</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="orderId" value="<%= order.orderId %>">
              <label for="cancelReason" class="form-label">Reason (optional)</label>
              <textarea class="form-control" name="reason" id="cancelReason" rows="3" placeholder="Why are you cancelling?"></textarea>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-outline-danger">Confirm Cancel</button>
            </div>
          </form>
        </div>
      </div>


      <% if (order.status === 'Delivered') { %>
        <button type="button" class="btn btn-warning w-100 mt-3" data-bs-toggle="modal" data-bs-target="#returnOrderModal">
          Return Order
        </button>
      <% } else if (order.status === 'Return Request') { %>
        <button class="btn btn-secondary w-100 mt-3" disabled>Return Request Pending</button>
      <% } else if (order.status === 'Returned') { %>
        <button class="btn btn-success w-100 mt-3" disabled>Order Returned</button>
      <% } %>



      <!-- Return Order Modal -->
      <div class="modal fade" id="returnOrderModal" tabindex="-1" aria-labelledby="returnOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <form action="/return-order" method="POST" class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="returnOrderModalLabel">Return Order</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="orderId" value="<%= order.orderId %>">
              <label for="returnReason" class="form-label">Reason for return <span class="text-danger">*</span></label>
              <textarea class="form-control" name="reason" id="returnReason" rows="3" required placeholder="State reason for returning the order"></textarea>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-warning">Submit Return Request</button>
            </div>
          </form>
        </div>
      </div>



    </div>
  </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const urlParams = new URLSearchParams(window.location.search);

  if (urlParams.get('returnSuccess') === 'true') {
    Swal.fire({
      icon: 'success',
      title: 'Return Request Submitted',
      text: 'Your return request has been successfully submitted.',
      confirmButtonColor: '#46698f'
    }).then(() => {
      const url = new URL(window.location);
      url.searchParams.delete('returnSuccess');
      window.history.replaceState({}, document.title, url.toString());
    });
  }

  if (urlParams.get('cancelSuccess') === 'true') {
    Swal.fire({
      icon: 'success',
      title: 'Order Cancelled',
      text: 'Your order has been successfully cancelled.',
      confirmButtonColor: '#d33'
    }).then(() => {
      const url = new URL(window.location);
      url.searchParams.delete('cancelSuccess');
      window.history.replaceState({}, document.title, url.toString());
    });
  }

  if (urlParams.get('itemCancelSuccess') === 'true') {
    Swal.fire({
      icon: 'success',
      title: 'Product Cancelled',
      text: 'The product was successfully cancelled from your order.',
      confirmButtonColor: '#d33'
    }).then(() => {
      const url = new URL(window.location);
      url.searchParams.delete('itemCancelSuccess');
      window.history.replaceState({}, document.title, url.toString());
    });
  }
</script>



<%- include('../partials/user/footer') %>